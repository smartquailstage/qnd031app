{% extends "base_dash.html" %}
{% load widget_tweaks %}
{% load static %}

{% block content %}

        <div class="page-content-wrapper">
          <!-- start page content-->
            <div class="page-content">

        <!-- Primera fila fuera del contenedor -->
        <div class="row">
            <div class="col-12 col-lg-8 col-xl-12">
                <div class="card overflow-hidden radius-10">
                    <div class="profile-cover-3 bg-dark position-relative mb-4">
                        <!-- Logo arriba a la derecha -->


                        <!-- Avatar centrado -->
                        <div class="user-profile-avatar position-absolute top-50 start-0 translate-middle-x">
                      
                                <img src="{% static 'assets/meddes/Informes_avatar.png' %}" alt="User Photo">
                    
                        </div>

                           <div class="d-block d-md-none position-absolute bottom-0 end-0 p-2">
                    <img src="{% static 'img/BA-LOGOS/logo.png' %}" alt="Logo" style="
    height: 28px;
    background-color: rgb(255 255 255);
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    padding: 4px;
    box-shadow: 0 0 0px rgba(0, 0, 0, 0.2);
    margin-bottom: -8px;
    margin-left: 0;
    margin-right: -9px;
                    ">
                </div>


                
                    </div>

    <div class="card-body text-left">


       


    <div class="col-12 col-md-6 mx-auto">
    <div class="card mb-4">

               <div class="card-body">
                                    <h2 class="font-weight-bold display-4" style="color:#45a851;">INFORMES TERAPÉUTICOS</h2>
                    <h4 class="mb-4">
                        Descarga tus informes terapeuticos al instante. 
                    </h4>

                <form method="get" class="row g-2 mb-4" id="date-filter-form">
                    <div class="col-6">
                      <label for="mes" class="form-label"></label>
                      <select name="mes" id="mes" class="form-select">
                        {% for numero, nombre in meses %}
                          <option value="{{ numero }}" {% if numero == mes %}selected{% endif %}>{{ nombre }}</option>
                        {% endfor %}
                      </select>
                    </div>

                    <div class="col-6">
                      <label for="anio" class="form-label"></label>
                      <select name="anio" id="anio" class="form-select">
                        {% for a in anios %}
                          <option value="{{ a }}" {% if a == anio %}selected{% endif %}>{{ a }}</option>
                        {% endfor %}
                      </select>
                    </div>

                    <div class="col-md-4 d-flex align-items-end">
                      <button type="submit" class="btn btn-success w-100"><ion-icon name="search-outline"></ion-icon> Buscar</button>
                    </div>
                  </form>

           
                
{% if not archivos %}

    <hr>
<p>Si aún no ha subido su informe de autorización, puede hacerlo aquí.</p>
  

  <!-- Formulario para subir informe terapéutico -->
  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Campo oculto para tipo_de_informe con valor por defecto "Autorizacion" -->
    <input type="hidden" name="tipo_de_informe" value="INI">

    <!-- Campo oculto para titulo con valor por defecto "Informe de autorización terapéutica" -->
    <input type="hidden" name="titulo" value="Informe de autorización terapéutica">

    <!-- Campo para seleccionar archivo del informe -->
    <div class="mb-3">
      <input id="file-input-informe" type="file" name="archivo" style="display: none;" required>

      <!-- Botón personalizado para activar el selector de archivo -->
      <button type="button" class="btn btn-outline-success" onclick="document.getElementById('file-input-informe').click();">
        <ion-icon name="cloud-upload-outline"></ion-icon>
        <span>Seleccionar archivo</span>
      </button>

      <!-- Mostrar nombre de archivo seleccionado -->
      <span id="file-name-informe" class="ms-2 text-muted" style="font-style: italic;"></span>
    </div>

    <!-- Botón para subir informe -->
    <button type="submit" class="btn btn-success ms-3">
      Subir Informe
    </button>

    <!-- Mostrar errores del formulario, si existen -->
    {% if form.errors %}
      <div class="alert alert-danger mt-3">
        <ul>
          {% for field in form %}
            {% for error in field.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </form>

  <!-- Script para mostrar el nombre del archivo seleccionado para informe -->
  <script>
    document.getElementById('file-input-informe').addEventListener('change', function () {
      const fileName = this.files.length > 0 ? this.files[0].name : '';
      document.getElementById('file-name-informe').textContent = fileName;
    });
  </script>

{% else %}

{% endif %}





                        <!-- Archivos adjuntos dinámicos -->
{% if archivos %}
    <hr>
    <h6 class="mt-4">Descargar Informes Terapéuticos</h6>
    <ul class="list-group list-group-flush">
        {% for archivo in archivos %}
        <a class="btn btn-sm btn-outline-primary" href="{{ archivo.archivo.url }}" target="_blank">
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <ion-icon name="document-outline"></ion-icon>
                    <strong>{{ archivo.titulo }}</strong>
                    <small class="text-muted">({{ archivo.fecha_creado|date:"d M Y" }})</small>
                </div>
            </li>
        </a>
        {% endfor %}
    </ul>
{% endif %}

                        
                    </div>
 
</div>

      
        </div>
    </div>
</div>

    </div>


                </div>
            </div> <!-- col -->
        </div> <!-- row -->

        <!-- Segunda fila dentro de un card y container -->





{% endblock %}


<div class="page-content-wrapper">
    <div class="page-content">


        <!-- Sección de Certificados y Autorización Terapéutica -->
        <div class="row mt-4">
            <div class="col-lg-12">
                <div class="card radius-10 bg-light border border-primary">
                    <div class="card-body">
                        <h5 class="card-title text-primary">Autorización Terapéutica y Certificados</h5>

                        <!-- Mostrar formulario solo si no hay archivos -->
                        {% if not archivos %}
                            <form method="POST" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="mb-3">
                                    {{ form.adjunto_autorizacion.label_tag }}
                                    {{ form.adjunto_autorizacion|add_class:"form-control" }}
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <ion-icon name="cloud-upload-outline"></ion-icon> Subir Autorización
                                </button>
                            </form>
                        {% else %}
                            <div class="alert alert-success mt-3">
                                <ion-icon name="checkmark-done-circle-outline"></ion-icon>
                                Ya se ha subido una autorización terapéutica. No es necesario cargar otra.
                            </div>
                        {% endif %}

                        <!-- Archivos adjuntos dinámicos -->
                        {% if archivos %}
                            <hr>
                            <h6 class="mt-4">Archivos adjuntos:</h6>
                            <ul class="list-group list-group-flush">
                                {% for archivo in archivos %}
                                <a class="btn btn-sm btn-outline-primary" href="{{ archivo.archivo.url }}" target="_blank">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <ion-icon name="document-outline"></ion-icon>
                                            <strong>{{ archivo.titulo }}</strong>
                                            <small class="text-muted">({{ archivo.fecha_creado|date:"d M Y" }})</small>
                                        </div>
                                    </li>
                                </a>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>