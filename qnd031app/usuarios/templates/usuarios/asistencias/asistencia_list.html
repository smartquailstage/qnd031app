{% extends "base_dash.html" %}
{% load widget_tweaks %}
{% load static %}

{% block content %}

<style>
  .gris-oscuro {
    background-color: #343a40;
    color: white;
  }
</style>

<input type="file" id="videoInput" name="media_terapia" accept="video/*">
<input type="hidden" id="thumbnailData" name="thumbnail_data">

<video id="videoPreview" style="display:none;"></video>
<canvas id="canvas" style="display:none;"></canvas>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="page-content-wrapper">
  <div class="page-content">

    <div class="row">
      <div class="col-12 col-lg-8 col-xl-12">
        <div class="card overflow-hidden radius-10">
          <div class="profile-cover-2 bg-dark position-relative mb-4">
            <div class="user-profile-avatar position-absolute top-50 start-0 translate-middle-x">
              <img src="{% static 'assets/meddes/visto.png' %}" alt="User Photo">
            </div>
          </div>

          <div class="card-body text-left">
            <div class="col-12 col-md-6 mx-auto">
              <div class="card mb-4">
                <div class="card-body">

                  <h2 class="font-weight-bold display-4" style="color:#45a851;">ASISTENCIAS</h2>
                  <h4 class="mb-4">Sus asistencias terapéuticas.</h4>

                  <form method="get" class="row g-3 mb-4" id="date-filter-form">
                    <div class="col-md-4">
                      <label for="mes" class="form-label">Mes:</label>
                      <select name="mes" id="mes" class="form-select">
                        {% for numero, nombre in meses %}
                          <option value="{{ numero }}" {% if numero|stringformat:"s" == mes|stringformat:"s" %}selected{% endif %}>{{ nombre }}</option>
                        {% endfor %}
                      </select>
                    </div>

                    <div class="col-md-4">
                      <label for="anio" class="form-label">Año:</label>
                      <select name="anio" id="anio" class="form-select">
                        {% for a in anios %}
                          <option value="{{ a }}" {% if a|stringformat:"s" == anio|stringformat:"s" %}selected{% endif %}>{{ a }}</option>
                        {% endfor %}
                      </select>
                    </div>

                    <div class="col-md-4">
                      <label for="asistio" class="form-label">Asistencia:</label>
                      <select name="asistio" id="asistio" class="form-select">
                        <option value="" {% if asistio == "" %}selected{% endif %}>Todos</option>
                        <option value="1" {% if asistio == "1" %}selected{% endif %}>Asistidos</option>
                        <option value="0" {% if asistio == "0" %}selected{% endif %}>No asistidos</option>
                      </select>
                    </div>

                    <div class="col-12 d-flex justify-content-end">
                      <button type="submit" class="btn btn-success">Filtrar</button>
                    </div>
                  </form>

                  <div style="max-height: 300px; overflow-y: auto; max-width: 357px; overflow-x: hidden;">
                    <table class="table mb-0 table-dark table-striped">
                      <tbody>
                        {% for actividad in actividades %}
                          <tr>
                            <th scope="row" style="background-color: #6c757d;">{{ forloop.counter }}</th>
                            <td style="background-color: #495057;">
                              {{ actividad.cita_terapeutica_asignada|date:"d-m-Y" }}
                            </td>
                            <td style="background-color: #343a40;">
                              {{ actividad.envio_tarea|yesno:"Sí,No" }}
                            </td>
                          </tr>
                        {% empty %}
                          <tr>
                            <td colspan="3" class="text-center">No hay actividades para estos filtros.</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>

                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.getElementById('videoInput').addEventListener('change', function (event) {
  const file = event.target.files[0];
  if (!file) return;

  const video = document.getElementById('videoPreview');
  const canvas = document.getElementById('canvas');
  const hiddenInput = document.getElementById('thumbnailData');

  video.preload = "metadata";
  video.src = URL.createObjectURL(file);
  video.load();

  video.addEventListener('loadedmetadata', function () {
    video.currentTime = 1;
  }, { once: true });

  video.addEventListener('seeked', function () {
    canvas.width = 160;
    canvas.height = 160;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataURL = canvas.toDataURL('image/jpeg');
    hiddenInput.value = dataURL;

    const thumbnail = document.getElementById('thumbnailPreview');
    if (thumbnail) {
      thumbnail.src = dataURL;
    }

    console.log("Miniatura generada y aplicada.");
  }, { once: true });
});
</script>
{% endblock %}
