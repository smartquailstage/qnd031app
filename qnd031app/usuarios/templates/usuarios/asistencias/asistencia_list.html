{% extends "base_dash.html" %}
{% load widget_tweaks %}
{% load static %}

{% block content %}

<style>
  .gris-oscuro {
    background-color: #343a40;
    color: white;
  }
</style>

<input type="file" id="videoInput" name="media_terapia" accept="video/*">
<input type="hidden" id="thumbnailData" name="thumbnail_data">

<video id="videoPreview" style="display:none;"></video>
<canvas id="canvas" style="display:none;"></canvas>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="page-content-wrapper">
  <div class="page-content">

    <div class="row">
      <div class="col-12 col-lg-8 col-xl-12">
        <div class="card overflow-hidden radius-10">
          <div class="profile-cover-2 bg-dark position-relative mb-4">
            <div class="user-profile-avatar position-absolute top-50 start-0 translate-middle-x">
              <img src="{% static 'assets/meddes/visto.png' %}" alt="User Photo">
            </div>
                            <!-- Logotipo solo visible en pantallas pequeñas -->
                <div class="d-block d-md-none position-absolute bottom-0 end-0 p-2">
                    <img src="{% static 'img/BA-LOGOS/logo.png' %}" alt="Logo" style="
    height: 28px;
    background-color: rgb(255 255 255);
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    padding: 4px;
    box-shadow: 0 0 0px rgba(0, 0, 0, 0.2);
    margin-bottom: -9px;
    margin-left: 0;
    margin-right: -9px;
                    ">
                </div>
          </div>

          <div class="card-body text-left">
            <div class="col-12 col-md-6 mx-auto">
              <div class="card mb-4">
                <div class="card-body">

<h2 class="font-weight-bold display-4 text-end" style="color:#45a851; font-size: 23px;">ASISTENCIAS</h2>
<h4 class="mb-4 text-end">Revise sus asistencias terapéuticas</h4>

                  <form method="get" class="row g-2 mb-4" id="date-filter-form">
                    <div class="col-6">
                      <label for="mes" class="form-label"></label>
                      <select name="mes" id="mes" class="form-select">
                        {% for numero, nombre in meses %}
                          <option value="{{ numero }}" {% if numero == mes %}selected{% endif %}>{{ nombre }}</option>
                        {% endfor %}
                      </select>
                    </div>

                    <div class="col-6">
                      <label for="anio" class="form-label"></label>
                      <select name="anio" id="anio" class="form-select">
                        {% for a in anios %}
                          <option value="{{ a }}" {% if a == anio %}selected{% endif %}>{{ a }}</option>
                        {% endfor %}
                      </select>
                    </div>

                    <div class="col-md-4 d-flex align-items-end">
                      <button type="submit" class="btn btn-success w-100"><ion-icon name="search-outline"></ion-icon> Buscar</button>
                    </div>
                  </form>



                  <div style="
                  max-height: 309px;
  font-size: 11px;
  overflow-y: auto;
  max-width: 682px;
  overflow-x: hidden;
  margin-top: 20px;">
                    <table class="table mb-0 table-dark table-striped" style="font-size: 11px; overflow-y: auto; ">
                      <thead>
  <tr>
    <th>Fecha</th>
    <th>Actividad</th>
    <th>Asistió</th>
  </tr>
</thead>

                      <tbody>
                        {% for actividad in actividades %}
                          <tr>
                            <td style="background-color: #646464">
                              {{ actividad.cita_terapeutica_asignada|date:"d-m-Y" }}
                            </td>

                            <td style="background-color: #646464;">
                              {{ actividad.titulo }}
                            </td>

                            <td style="background-color: #646464;">
                              {{ actividad.asistire |yesno:"Sí,No" }}
                            </td>
                          </tr>
                        {% empty %}
                          <tr>
                            <td colspan="3" class="text-center">No hay actividades para estos filtros.</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>

                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.getElementById('videoInput').addEventListener('change', function (event) {
  const file = event.target.files[0];
  if (!file) return;

  const video = document.getElementById('videoPreview');
  const canvas = document.getElementById('canvas');
  const hiddenInput = document.getElementById('thumbnailData');

  video.preload = "metadata";
  video.src = URL.createObjectURL(file);
  video.load();

  video.addEventListener('loadedmetadata', function () {
    video.currentTime = 1;
  }, { once: true });

  video.addEventListener('seeked', function () {
    canvas.width = 160;
    canvas.height = 160;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataURL = canvas.toDataURL('image/jpeg');
    hiddenInput.value = dataURL;

    const thumbnail = document.getElementById('thumbnailPreview');
    if (thumbnail) {
      thumbnail.src = dataURL;
    }

    console.log("Miniatura generada y aplicada.");
  }, { once: true });
});
</script>
{% endblock %}
